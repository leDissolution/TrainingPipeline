environment: configs/environments/pod.yaml
vars:
  # LOGS_BASE: ${REPO_ROOT}/pipeline_runs

stages:
  - name: prepare_dataset
    script:
      name: ../DatasetProcessor/prepare_dataset.py
      venv: ../DatasetProcessor/.venv
      args:
        --with_loss: false
        --with_chats: false
        --with_synthetic: true

  - name: stage0_make_sweeps
    make_sweeps:
      base_config: configs/granite2b/stage0/base.yaml
      name: lr_boost_rank
      param_ranges:
        training.max_grad_norm: [1]

  - name: stage0
    env_variables:
      - name: CUDA_VISIBLE_DEVICES
        value: 1
    script:
      name: train.py
      args:
        --config: ${CONFIG_BASE}/granite2b/stage0/base.yaml
          #sweep: configs/granite2b/stage0/lr_boost_rank

  # - name: stage0_best
  #   script:
  #     name: ../select_best_checkpoint.py
  #     args:
  #       --input_dir: "./g2b-stage0-sweep/"
  #       --output_dir: "./g2b-stage0"

  - name: stage1_make_sweeps
    make_sweeps:
      base_config: configs/granite2b/stage1/base.yaml
      name: gate_lr
      param_ranges:
        layerwise_lr.groups["gate"].lr_scale: [0.25, 0.5]


  - name: stage1
    env_variables:
      - name: CUDA_VISIBLE_DEVICES
        value: 1
    script:
      name: train.py
      args:
        --config:
          sweep: ${CONFIG_BASE}/granite2b/stage1/gate_lr


  - name: stage2
    env_variables:
      - name: CUDA_VISIBLE_DEVICES
        value: 1
    script:
      name: train.py
      args:
        --config: ${CONFIG_BASE}/granite2b/stage2/base.yaml